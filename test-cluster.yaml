apiVersion: v1
kind: List
items:
- apiVersion: v1
  kind: Service
  metadata:
    name: test-cluster-master
    labels:
      cluster: test-cluster
      role: master
  spec:
    ports:
    - port: 6443
      protocol: TCP
      targetPort: 6443
    selector:
      cluster: test-cluster
      role: master
    sessionAffinity: None
    type: ClusterIP
- apiVersion: apps/v1
  kind: Deployment
  metadata:
    name: test-cluster-master
    labels:
      role: master
      cluster: test-cluster
  spec:
    replicas: 1
    selector:
      matchLabels:
        role: master
        cluster: test-cluster
    template:
      metadata:
        annotations:
          io.katacontainers.config_path: /opt/kata/share/defaults/kata-containers/configuration-qemu-debug.toml
          io.katacontainers.config.hypervisor.kernel: /var/lib/images/kernel/linuxkit/vmlinuz-5.4.19-linuxkit
          io.katacontainers.config.hypervisor.image: /var/lib/images/vm/kata-agent-ubuntu.img
          io.katacontainers.config.hypervisor.default_vcpus: "2"
          # kata cannot set VM memory correctly with linuxit kernel - TODO check if CONFIG_MEMORY_HOTPLUG is set
          io.katacontainers.config.hypervisor.default_memory: "4096"
        labels:
          role: master
          cluster: test-cluster
      spec:
        #runtimeClassName: kata-qemu
        volumes:
          - name: images
            hostPath:
              path: /var/lib/images
              type: Directory
          - name: bpf-maps
            hostPath:
              path: /sys/fs/bpf
              type: Directory
          # the following volumes are mostly required in non-kata setting, but should also work with kata
          - name: proc
            hostPath:
              path: /proc
              type: Directory
          - hostPath:
              # TODO: stop actually including modules in the image, these could live in kata VM, or better on the
              # host and managed by node init ds, the kata VM and kernel lifecycles are bound anyway, so either
              # way is the same, except that kata VM image might be better to keep small
              path: /lib/modules
              type: Directory
            name: lib-modules
          - hostPath:
              path: /run/xtables.lock
              type: FileOrCreate
            name: xtables-lock
        # TODO add initContainers to wait for /var/images to have the right files, or at least some file
        containers:
        - name: console
          image: errordeveloper/kubeadm:ubuntu-18.04-1.18.0@sha256:d3cec21f22055adc062ab43d24f3110c8a86e8577a4bddce857e87cd06231058
          imagePullPolicy: Always
          tty: true
          securityContext:
            privileged: true
          command:
            - /lib/systemd/systemd
            - --unit=kubeadm.target
          readinessProbe:
            exec:
              command:
                - /usr/bin/is-master-ready.sh
            initialDelaySeconds: 30
            periodSeconds: 2
            failureThreshold: 500
            successThreshold: 5
          env:
            - name: KUBECONFIG
              value: /etc/kubernetes/admin.conf
          volumeMounts:
            - mountPath: /images
              name: images
            - mountPath: /sys/fs/bpf
              name: bpf-maps
              mountPropagation: Bidirectional # required due to nesting, so that cilium pod can use
            - mountPath: /lib/modules
              name: lib-modules
              readOnly: true
            - mountPath: /run/xtables.lock
              name: xtables-lock
          #resources:
          #  requests:
          #    memory: 4Gi
          #    cpu: 2.1
          #  limits:
          #    memory: 4Gi
          #    cpu: 2.1
- apiVersion: apps/v1
  kind: Deployment
  metadata:
    name: test-cluster-node
    labels:
      role: node
      cluster: test-cluster
  spec:
    replicas: 3
    selector:
      matchLabels:
        role: node
        cluster: test-cluster
    template:
      metadata:
        annotations:
          io.katacontainers.config_path: /opt/kata/share/defaults/kata-containers/configuration-qemu-debug.toml
          io.katacontainers.config.hypervisor.kernel: /var/lib/images/kernel/linuxkit/vmlinuz-5.4.19-linuxkit
          io.katacontainers.config.hypervisor.image: /var/lib/images/vm/kata-agent-ubuntu.img
          io.katacontainers.config.hypervisor.default_vcpus: "2"
          # kata cannot set VM memory correctly with linuxit kernel - TODO check if CONFIG_MEMORY_HOTPLUG is set
          io.katacontainers.config.hypervisor.default_memory: "4096"
        labels:
          role: node
          cluster: test-cluster
      spec:
        #runtimeClassName: kata-qemu
        volumes:
          - name: images
            hostPath:
              path: /var/lib/images
              type: Directory
          - name: bpf-maps
            hostPath:
              path: /sys/fs/bpf
              type: Directory
          # the following volumes are mostly required in non-kata setting, but should also work with kata
          - hostPath:
              # TODO: stop actually including modules in the image, these could live in kata VM, or better on the
              # host and managed by node init ds, the kata VM and kernel lifecycles are bound anyway, so either
              # way is the same, except that kata VM image might be better to keep small
              # TODO: qn - does kata mount 
              path: /lib/modules
              type: Directory
            name: lib-modules
          - hostPath:
              path: /run/xtables.lock
              type: FileOrCreate
            name: xtables-lock
        containers:
        - name: console
          image: errordeveloper/kubeadm:ubuntu-18.04-1.18.0@sha256:d3cec21f22055adc062ab43d24f3110c8a86e8577a4bddce857e87cd06231058
          imagePullPolicy: Always
          tty: true
          securityContext:
            privileged: true
          readinessProbe:
            exec:
              command:
                - systemctl
                - --no-pager
                - is-active
                - multi-user.target
            initialDelaySeconds: 120
            periodSeconds: 2
            failureThreshold: 500
          volumeMounts:
            - mountPath: /images
              name: images
            - mountPath: /sys/fs/bpf
              name: bpf-maps
              mountPropagation: Bidirectional # required due to nesting, so that cilium pod can use
            - mountPath: /lib/modules
              name: lib-modules
              readOnly: true
            - mountPath: /run/xtables.lock
              name: xtables-lock
